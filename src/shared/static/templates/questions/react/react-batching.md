# ❓ Что такое батчинг (batching) в React?

---

## Определение

**Батчинг** — это механизм, при котором React **группирует несколько вызовов `setState` (или хуков состояния) в один ререндер**, чтобы избежать лишних перестроений UI и повысить производительность.

---

## Как это работает

- React **ждёт**, пока закончится текущий обработчик события (или синхронный код внутри root), и только **после этого** обрабатывает все накопленные обновления состояния за раз :contentReference[oaicite:0]{index=0}.  
- В результате, даже если вы вызываете `setState` несколько раз подряд, React выполнит **единственный** ререндер.

```jsx
function Counter() {
  const [n, setN] = useState(0);
  const [f, setF] = useState(false);

  function handleClick() {
    setN(n + 1);
    setF(f => !f);
    // React выполнит только один ререндер после выхода из handleClick
  }

  return (
    <button onClick={handleClick}>
      {n} — {f ? 'ON' : 'OFF'}
    </button>
  );
}
```

---

## Эволюция batching

1. **React 17 и ранее**

   - Батчинг работал **только в React-событиях** (например, `onClick`) ([freecodecamp.org][1]).
   - В асинхронных колбэках (`setTimeout`, `Promise.then`) обновления рендерились по отдельности.

2. **React 18+**

   - **Автоматический batching** распространяется на **все** обновления внутри одного корня (`createRoot`), включая асинхронные колбэки.
   - Это снижает количество ререндеров и улучшает отзывчивость приложения.

---

## Принудительный сброс batching

- Если нужно **моментально** применить обновление и обойти batching, используйте `flushSync`:

```js
import { flushSync } from 'react-dom';

function handleClick() {
  flushSync(() => {
    setCount(c => c + 1);
  });
  setFlag(f => !f);
  // Обновление count произойдёт сразу, несмотря на batching
}
```

---

## Итог

- **Батчинг** объединяет несколько обновлений состояния в **один** ререндер.
- Это **улучшает производительность** и предотвращает «полузаконченные» рендеры.
- В React 18 batching автоматизирован во всех случаях, а в более старых версиях — только в React-событиях.

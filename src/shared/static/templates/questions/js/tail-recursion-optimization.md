# ❓ Как оптимизировать хвостовую рекурсию?

---

## Хвостовая рекурсия

- **Хвостовая рекурсия** — это рекурсивный вызов, который является последней операцией в функции (возврат результата вызова функции без дополнительной обработки).

- Пример хвостовой рекурсии:

```js
function factorial(n, acc = 1) {
  if (n <= 1) return acc;
  return factorial(n - 1, n * acc); // хвостовой вызов
}
```

---

## Оптимизация хвостовой рекурсии (TCO — Tail Call Optimization)

- TCO — механизм компилятора/интерпретатора, при котором вызовы хвостовой рекурсии не создают новые кадры стека, а переиспользуют текущий.

- Позволяет избежать переполнения стека при глубокой рекурсии.

---

## Особенности в JavaScript

- Спецификация ECMAScript 2015 (ES6) требует поддержки TCO в строгом режиме (`'use strict'`), но **большинство современных движков (V8, SpiderMonkey) её не реализуют**.

- Из-за этого в JavaScript хвостовая рекурсия не всегда эффективна.

---

## Как оптимизировать без TCO?

1. **Переписать рекурсию в итерацию**

   ```js
   function factorialIter(n) {
     let acc = 1;
     while (n > 1) {
       acc *= n;
       n--;
     }
     return acc;
   }
   ```

2. **Использовать цикл и аккумулятор вместо рекурсии**

3. **Использовать trampolining** — техника для имитации TCO через функцию-обёртку:

   ```js
   function trampoline(fn) {
     return function trampolined(...args) {
       let result = fn(...args);
       while (typeof result === 'function') {
         result = result();
       }
       return result;
     };
   }

   function factorial(n, acc = 1) {
     if (n <= 1) return acc;
     return () => factorial(n - 1, n * acc);
   }

   const factorialTrampolined = trampoline(factorial);
   factorialTrampolined(100000); // не переполнит стек
   ```

---

## Итог

- В JS нет гарантированной поддержки TCO, поэтому хвостовую рекурсию нужно оптимизировать вручную.

- Лучшие методы — переписать в итеративный стиль или использовать trampolining.

- Понимание хвостовой рекурсии важно для эффективной работы с рекурсивными алгоритмами и предотвращения переполнения стека.

---
